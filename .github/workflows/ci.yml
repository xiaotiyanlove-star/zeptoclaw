name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: -Dwarnings
  BINARY_SIZE_LIMIT_MB: 10

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - run: cargo test --lib
      - run: cargo test --bin zeptoclaw
      - run: cargo test --test cli_smoke
      - run: cargo test --test integration
      - run: cargo test --test e2e
      - run: cargo test --doc
      - name: Test with memory-bm25 feature
        run: cargo test --lib --features memory-bm25
      - name: Test with hardware features (ESP32)
        run: cargo test --lib --features peripheral-esp32

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
      - run: cargo clippy -- -D warnings
      - name: Clippy with hardware features
        run: cargo clippy --features peripheral-esp32 -- -D warnings

  fmt:
    name: Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - run: cargo fmt --check

  audit:
    name: Security audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: rustsec/audit-check@v2.0.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

  # Heavy checks that only run on main merges
  riscv64-smoke:
    name: RISC-V smoke test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    env:
      RUSTFLAGS: -Dwarnings --cfg getrandom_backend="linux_raw"
      CARGO_TARGET_RISCV64GC_UNKNOWN_LINUX_MUSL_LINKER: riscv64-linux-gnu-gcc
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: riscv64gc-unknown-linux-musl
      - uses: Swatinem/rust-cache@v2
        with:
          key: riscv64
      - name: Install QEMU and cross-linker
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-user gcc-riscv64-linux-gnu
      - name: Cross-compile smoke test
        run: cargo build --release --target riscv64gc-unknown-linux-musl --example riscv_smoke
      - name: Run under QEMU
        run: |
          qemu-riscv64 -L /usr/riscv64-linux-gnu \
            target/riscv64gc-unknown-linux-musl/release/examples/riscv_smoke
          echo "### RISC-V smoke test passed (Uuid::new_v4 ok)" >> "$GITHUB_STEP_SUMMARY"

  binary-size:
    name: Binary size
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - run: cargo build --release
      - name: Check binary size
        run: |
          size_bytes=$(stat --format=%s target/release/zeptoclaw)
          size_mb=$(awk "BEGIN {printf \"%.1f\", ${size_bytes}/1048576}")
          echo "Binary size: ${size_mb} MB (limit: ${BINARY_SIZE_LIMIT_MB} MB)"
          echo "### Binary size: ${size_mb} MB" >> "$GITHUB_STEP_SUMMARY"
          limit_bytes=$((BINARY_SIZE_LIMIT_MB * 1048576))
          if [ "${size_bytes}" -gt "${limit_bytes}" ]; then
            echo "Binary exceeds ${BINARY_SIZE_LIMIT_MB} MB limit!" >&2
            exit 1
          fi
